@if (!isLoaded()) {
  <div class="loading-container">
    <mat-spinner diameter="60"></mat-spinner>
    <p>Loading jam session...</p>
  </div>
} @else {
  <div class="session-page-container">
    <div class="content">
      <!-- Session Details Card -->
      <mat-card class="session-details-card">
        <mat-card-header class="card-header">
          <mat-card-title>
            <mat-icon>music_note</mat-icon>
            <span>{{ owner() }}'s Jam Session</span>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- Session Info Grid -->
          <div class="info-grid">
            <div class="info-item">
              <mat-icon>event</mat-icon>
              <span>{{ date() | date:'mediumDate' }}</span>
            </div>
            <div class="info-item">
              <mat-icon>access_time</mat-icon>
              <span>{{ time() | slice:0:5 }}</span>
            </div>
            <div class="info-item">
              <mat-icon>music_note</mat-icon>
              <span>{{ jamSession()?.musicGenre.name }}</span>
            </div>
            <div class="info-item">
              <mat-icon>location_on</mat-icon>
              <span>{{ address() }}</span>
            </div>
          </div>

          <!-- Required Instruments -->
          <div class="instruments-section">
            <h3 class="section-title">
              <mat-icon>piano</mat-icon>
              Required Instruments
            </h3>
            <div class="instruments-chips">
              @for (instrument of groupedRequiredInstruments(); track instrument.name) {
                <div 
                  class="instrument-chip"
                  [class.disabled]="isInstrumentConfirmed(instrument.name)"
                  (click)="!isInstrumentConfirmed(instrument.name) && openDialog(instrument.name)">
                  <mat-icon>music_note</mat-icon>
                  <span>{{ instrument.name }}</span>
                  <span class="count-badge">{{ instrument.confirmed }}/{{ instrument.total }}</span>
                </div>
              }
            </div>
            <div class="hint-text">
              <small *ngIf="!isAlreadySignedUp()">Click to sign up - Numbers show confirmed/total needed</small>
              <small *ngIf="isAlreadySignedUp()" class="success-text">You are already signed up for this session</small>
            </div>
          </div>

          <!-- My Signed-up Instruments -->
          <div class="instruments-section" *ngIf="user() && myConfirmedInstruments().length > 0">
            <h3 class="section-title">
              <mat-icon>check_circle</mat-icon>
              My Signed-up Instruments
            </h3>
            <div class="instruments-chips">
              @for (item of myConfirmedInstruments(); track item.instrumentName) {
                <div class="instrument-chip confirmed" (click)="openRemoveDialog()">
                  <mat-icon>done</mat-icon>
                  <span>{{ item.instrumentName }}</span>
                </div>
              }
            </div>
            <div class="hint-text">
              <small>Click to leave session</small>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Map Card -->
      <mat-card class="map-card">
        <mat-card-header class="card-header">
          <mat-card-title>
            <mat-icon>map</mat-icon>
            <span>Location</span>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content class="map-content">
          <app-map [givenCoordinates]="coordinates()"></app-map>
        </mat-card-content>
      </mat-card>

      <!-- Owner Table -->
      <mat-card class="table-card owner-card">
        <mat-card-header class="card-header">
          <mat-card-title>
            <mat-icon>person</mat-icon>
            <span>Session Owner</span>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content class="table-content">
          <table mat-table [dataSource]="ownerDataSource()">
            <ng-container matColumnDef="attendee">
              <th *matHeaderCellDef mat-header-cell>Name</th>
              <td *matCellDef="let element" mat-cell>{{ element.name }}</td>
            </ng-container>

            <ng-container matColumnDef="instrument">
              <th *matHeaderCellDef mat-header-cell>Role</th>
              <td *matCellDef="let element" mat-cell>
                <span class="role-badge owner-badge">Owner</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="page">
              <th *matHeaderCellDef mat-header-cell></th>
              <td *matCellDef="let element" mat-cell>
                <button mat-icon-button class="nav-btn" (click)="navigateToPage(element.id)" matTooltip="View Profile">
                  <mat-icon>arrow_forward_ios</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr *matHeaderRowDef="ownerColumns" mat-header-row></tr>
            <tr *matRowDef="let row; columns: ownerColumns;" mat-row></tr>
          </table>
        </mat-card-content>
      </mat-card>

      <!-- Participants Table -->
      <mat-card class="table-card participants-card">
        <mat-card-header class="card-header">
          <mat-card-title>
            <mat-icon>group</mat-icon>
            <span>Participants</span>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content class="table-content">
          <table mat-table [dataSource]="dataSource()">
            <ng-container matColumnDef="attendee">
              <th *matHeaderCellDef mat-header-cell>Attendee</th>
              <td *matCellDef="let element" mat-cell>{{ element.name }}</td>
            </ng-container>

            <ng-container matColumnDef="instrument">
              <th *matHeaderCellDef mat-header-cell>Instrument</th>
              <td *matCellDef="let element" mat-cell>{{ element.instrumentName }}</td>
            </ng-container>

            <ng-container matColumnDef="rating">
              <th *matHeaderCellDef mat-header-cell>Rating</th>
              <td *matCellDef="let element" mat-cell>
                <span class="rating-badge">{{ element.rating }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="page">
              <th *matHeaderCellDef mat-header-cell></th>
              <td *matCellDef="let element" mat-cell>
                <button mat-icon-button class="nav-btn" (click)="navigateToPage(element.userId)" matTooltip="View Profile">
                  <mat-icon>arrow_forward_ios</mat-icon>
                </button>
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th *matHeaderCellDef mat-header-cell></th>
              <td *matCellDef="let element" mat-cell>
                <button 
                  *ngIf="canRemoveParticipant()"
                  mat-icon-button 
                  class="remove-btn"
                  (click)="removeParticipant(element.userId, element.name)" 
                  matTooltip="Remove participant">
                  <mat-icon>person_remove</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr *matHeaderRowDef="columns" mat-header-row></tr>
            <tr *matRowDef="let row; columns: columns;" mat-row></tr>
          </table>
        </mat-card-content>
      </mat-card>

      <!-- Comments Section -->
      <mat-card class="comments-card">
        <mat-card-header class="card-header">
          <mat-card-title>
            <mat-icon>chat</mat-icon>
            <span>Comments</span>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- Add Comment Form -->
          <div class="comment-form">
            <h3 class="form-title">{{ replyingTo() ? 'Reply to ' + replyingTo()!.author.name : 'Add a Comment' }}</h3>
            @if (replyingTo()) {
              <div class="replying-banner">
                <mat-icon>reply</mat-icon>
                <span>{{ replyingTo()!.message.substring(0, 50) }}{{ replyingTo()!.message.length > 50 ? '...' : '' }}</span>
                <button mat-icon-button (click)="cancelReply()">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            }
            <mat-form-field appearance="outline" class="comment-input">
              <mat-label>{{ replyingTo() ? 'Write your reply...' : 'Share your thoughts' }}</mat-label>
              <textarea 
                matInput 
                [ngModel]="newCommentText()"
                (ngModelChange)="newCommentText.set($event)"
                rows="3" 
                placeholder="Share your thoughts about this jam session..."
                [disabled]="submittingComment()">
              </textarea>
            </mat-form-field>
            
            <div class="form-actions">
              <div class="image-upload">
                <input 
                  type="file" 
                  #fileInput 
                  accept="image/*" 
                  (change)="onCommentImageSelected($event)"
                  style="display: none">
                <button 
                  mat-stroked-button 
                  type="button" 
                  (click)="fileInput.click()"
                  [disabled]="submittingComment()">
                  <mat-icon>add_photo_alternate</mat-icon>
                  Add Image
                </button>
                <div *ngIf="imagePreview()" class="image-preview">
                  <img [src]="imagePreview()" alt="preview">
                  <button 
                    mat-icon-button 
                    (click)="selectedImageFile.set(null); imagePreview.set(null)"
                    class="remove-preview">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
              <button 
                mat-raised-button 
                class="submit-comment-btn"
                (click)="submitComment()"
                [disabled]="submittingComment() || !newCommentText().trim()">
                <mat-icon>send</mat-icon>
                {{ replyingTo() ? 'Post Reply' : 'Post Comment' }}
              </button>
            </div>
          </div>

          <!-- Comments List -->
          <div class="comments-list" *ngIf="comments().length > 0; else noComments">
            <ng-container *ngTemplateOutlet="commentThread; context: { $implicit: comments(), depth: 0 }"></ng-container>
          </div>
          
          <ng-template #commentThread let-commentList let-depth="depth">
            <div class="comment-item" *ngFor="let comment of commentList" [style.margin-left.px]="depth * 20">
              <div class="comment-header">
                <div class="comment-author">
                  <mat-icon>account_circle</mat-icon>
                  <strong>{{ comment.author.name }}</strong>
                </div>
                <div class="comment-meta">
                  <small>{{ comment.createdAt | date:'short' }}</small>
                  <button 
                    *ngIf="isAdmin()" 
                    mat-icon-button 
                    class="delete-comment-btn"
                    (click)="deleteComment(comment)"
                    matTooltip="Delete comment">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
              <p class="comment-text">{{ comment.message }}</p>
              <div class="comment-image-wrapper" *ngIf="comment.imageUrl">
                <app-lazy-image 
                  [src]="comment.imageUrl" 
                  [cssClass]="'comment-image'"
                  [altText]="'Comment image by ' + comment.author.name">
                </app-lazy-image>
              </div>
              
              <!-- Reactions -->
              <div class="comment-reactions">
                <div class="reaction-display" *ngIf="comment.reactionCount > 0">
                  <span *ngFor="let entry of comment.reactionSummary | keyvalue" class="reaction-item">
                    {{ getReactionEmoji(entry.key) }} {{ entry.value }}
                  </span>
                </div>
                <div class="reaction-buttons">
                  <button 
                    mat-button 
                    *ngFor="let reaction of reactionTypes"
                    (click)="reactToComment(comment.id, reaction.type)"
                    [matTooltip]="reaction.label"
                    class="reaction-btn">
                    {{ reaction.emoji }}
                  </button>
                  <button 
                    mat-button 
                    *ngIf="canReply(comment)"
                    (click)="replyToComment(comment)" 
                    class="reply-btn">
                    <mat-icon>reply</mat-icon>
                    Reply
                  </button>
                </div>
              </div>
              
              <!-- Nested replies -->
              <div class="replies" *ngIf="comment.replies && comment.replies.length > 0">
                <ng-container *ngTemplateOutlet="commentThread; context: { $implicit: comment.replies, depth: depth + 1 }"></ng-container>
              </div>
            </div>
          </ng-template>
          
          <ng-template #noComments>
            <div class="no-comments">
              <mat-icon>chat_bubble_outline</mat-icon>
              <p>No comments yet. Be the first to comment!</p>
            </div>
          </ng-template>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Floating Notes Background -->
    <div class="floating-notes">
      <div class="note note-1">♪</div>
      <div class="note note-2">♫</div>
      <div class="note note-3">♩</div>
      <div class="note note-4">♬</div>
      <div class="note note-5">♪</div>
      <div class="note note-6">♫</div>
    </div>
  </div>
}

